name: Screenshot

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  screenshot-ubuntu:
    name: Generate screenshot on Ubuntu
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            cmake g++ qt6-base-dev zlib1g-dev \
            xvfb scrot xdotool openbox

      - name: Configure CMake
        run: cmake -S . -B build

      - name: Build
        run: cmake --build build

      - name: Download gpscan
        run: |
          curl -L -o gpscan.tar.gz https://github.com/kojix2/gpscan/releases/download/v0.1.3/gpscan-x86_64-unknown-linux-musl.tar.gz
          tar -xzf gpscan.tar.gz
          chmod +x gpscan
          ./gpscan --version

      - name: Scan /
        run: |
          # gpscan does not cross filesystem boundaries by default.
          # This keeps /proc, /sys, /dev, /run (separate mounts) out of the scan.
          sudo timeout 15m ./gpscan --quiet --force --output scan.gpscan /
          ls -lh scan.gpscan

      - name: Render screenshot (headless)
        run: |
          # Start Xvfb, a window manager, launch the viewer, wait for window, then capture it.
          export DISPLAY=:99
          Xvfb :99 -screen 0 1600x900x24 &
          sleep 1
          openbox &
          sleep 1

          ./build/gpscan_viewer scan.gpscan &
          pid=$!

          # Wait for the window to appear (up to 30s)
          for i in $(seq 1 30); do
            if xdotool search --name "gpscan_viewer" >/dev/null 2>&1; then
              break
            fi
            sleep 1
          done

          sleep 3  # Let it fully render

          # Capture just the viewer window
          win_id=$(xdotool search --name "gpscan_viewer" | head -1)
          if [ -n "$win_id" ]; then
            scrot -w "$win_id" root.png
          else
            echo "Window not found, capturing entire screen"
            scrot root.png
          fi

          kill "$pid" >/dev/null 2>&1 || true
          wait "$pid" >/dev/null 2>&1 || true

          test -s root.png
          ls -lh root.png

      - name: Publish screenshot branch
        run: |
          set -euo pipefail

          tmp_dir="$(mktemp -d)"
          cp root.png "$tmp_dir/root.png"
          date -u +"Generated at %Y-%m-%dT%H:%M:%SZ" > "$tmp_dir/GENERATED.txt"

          git config user.name "github-actions[bot]"
          # 41898282 is the numeric user id of github-actions[bot].
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git switch --orphan screenshot
          git reset --hard
          git clean -fdx

          cp "$tmp_dir/root.png" ./root.png
          cp "$tmp_dir/GENERATED.txt" ./GENERATED.txt
          git add root.png GENERATED.txt

          if git diff --cached --quiet; then
            echo "No changes to screenshot."
            exit 0
          fi

          git commit -m "Update screenshot"
          git push --force origin HEAD:screenshot
