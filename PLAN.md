
# gpscan_viewer: GrandPerspective Scan Viewer Port Plan

## 1. Goals

- Build a GUI viewer for Linux that can load **scan result files generated by GrandPerspective** and visualize them as a treemap (rectangular subdivision).
- **Do not implement scanning** (directory traversal, size calculation, filtered rescan, etc. are out of scope).
- Deliver a minimal, end-to-end use case quickly: "open file -> render -> click to show details".

## 2. Non-Goals

- Do not port the macOS app (AppKit/XIB) to Linux as-is.
- Exclude QuickLook, Trash integration, Finder integration, macOS-specific menus, and settings panels.
- Do not fully replicate GrandPerspective UI/UX (features will be added iteratively).
- Do not define a new file format (follow existing formats).

## 3. Deliverables

- A standalone C++/Qt application under `gpscan_viewer/` (CMake build).
- Input: files equivalent to GrandPerspective "Load Scan Data" output (XML or raw).
- Output: GUI treemap visualization, basic info display (path/size), optional image export.
- Documentation: build steps, supported formats, known limitations.

## 4. Technology Choices

- Language: C++17
- GUI: Qt6 Widgets
- Build: CMake
- XML parsing: `tinyxml2` preferred (can switch to Qt `QXmlStreamReader` to reduce dependencies)

Reasoning: Qt provides `QPainter`/`QImage`/event handling, enabling zoom, pan, and selection with concise code.

## 5. Reference Code (Spec Sources)

### 5.1 Input/Output

- `src/io/TreeReader.m` (reading existing data)
- `src/io/XmlTreeWriter.m` (XML format output spec)
- `src/io/RawTreeWriter.m` (raw format output spec)

### 5.2 Model (Tree Structure)

- `src/tree/Item.*`, `FileItem.*`, `DirectoryItem.*`
- `src/tree/TreeContext.*`, `ScanTreeRoot.*`

### 5.3 Layout/Rendering (Algorithm References)

- `src/tree/TreeLayoutBuilder.*` (rectangular subdivision logic)
- `src/view/TreeDrawer*.*`, `src/view/DirectoryView.m` (rendering and interaction)

Note: This project re-implements rendering/UI in Qt; the above are references for spec/behavior only.

## 6. Architecture (Minimal)

### 6.1 Data Flow

1) Select file (Open)
2) `TreeReader` parses the file and builds `TreeModel`
3) `TreeLayout` assigns rectangles for the view (each node gets a `Rect`)
4) `CanvasWidget` renders using `QPainter`
5) Input (click/hover/zoom) triggers highlight and info display

### 6.2 Module Responsibilities

- `TreeModel`:
	- Node structure (directory/file)
	- Size (prefer logical if logical/physical are distinguished)
	- Path (display string)
	- Child list and parent link (optional)

- `TreeReader`:
	- Read XML/raw and build `TreeModel`
	- Return errors as `Result` for UI display

- `TreeLayout`:
	- Treemap layout (primary goal is "visible" layout first)
	- Initially use a squarify-like approach or partially port `TreeLayoutBuilder`
	- Extensions: depth, minimum rectangle threshold, padding

- `CanvasWidget`:
	- Draw rectangles in `paintEvent()`
	- Click to select, hover for tooltip
	- Zoom/pan (can be deferred to phase 2)

- `ViewerWindow`:
	- Menu (Open / Reload / Quit)
	- Display selection info in status bar

## 7. Directory Plan

```
gpscan_viewer/
	CMakeLists.txt
	README.md
	PLAN.md
	src/
		main.cpp
		ViewerWindow.h/.cpp
		CanvasWidget.h/.cpp
		TreeModel.h/.cpp
		TreeReader.h/.cpp
		TreeLayout.h/.cpp
	resources/
		(put sample scan result files here)
```

## 8. Milestones (Incremental)

### M0: Scaffolding (Low)

- Build and launch a Qt6 Widgets app with CMake
- Show an empty canvas

### M1: File Loading (Medium)

- Load XML (priority) via Open
- Show user-facing errors on parse failure

### M2: Static Treemap (Medium-High)

- Render rectangles under root according to size ratio
- Click to select a rectangle and show path/size

### M3: Usability (Medium)

- Tooltips on hover
- Zoom (double-click to focus, back button, etc.)

### M4: Extras (Optional)

- Image export (PNG)
- Coloring rules (extension/type/random/fixed)
- Support raw format

## 9. Acceptance Criteria

- On Linux, "Open" can visualize the sample file.
- The rendered rectangle area ratio roughly matches file size ratio.
- Clicking a node shows at least name (or path) and size in the UI.
- Invalid files or format mismatch show an error instead of crashing.

## 10. Risks and Mitigations

1) Input format ambiguity
	 - Mitigation: prioritize XML output; defer raw support.
	 - Need: at least one real generated file in `resources/`.

2) Layout differences
	 - Mitigation: start with a "visible" layout (e.g., squarify).
	 - Later: match `TreeLayoutBuilder` behavior more closely.

3) Performance on large data sets
	 - Mitigation: initial simple rendering (up to a fixed depth) + minimum rectangle cutoff.
	 - Future: tiling, incremental rendering, caching.

## 11. Required Inputs (From User)

- Scan result files generated by GrandPerspective (XML preferred; raw optional)
	- Ideally two sizes (small/medium) with different node counts
	- Place under `gpscan_viewer/resources/`

---

Change log:
- 2026-01-19 Initial version

